name: Obtener URL del APK desde EAS

on:
  push:
    branches:
      - test-2  # Cambiar a la rama adecuada, por ejemplo, main

jobs:
  obtener-apk:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“‚ Checkout del repositorio
        uses: actions/checkout@v3

      - name: ðŸ“¦ Instalar EAS CLI
        run: |
          npm install -g eas-cli
          eas --version  # Verificar la versiÃ³n instalada de eas-cli para depuraciÃ³n

      - name: ðŸ” Iniciar sesiÃ³n en EAS
        run: |
          echo "Iniciando sesiÃ³n con EAS..."
          eas login --non-interactive
        env:
          EAS_EMAIL: ${{ vars.EAS_EMAIL }}
          EAS_PASSWORD: ${{ vars.EAS_PASSWORD }}

      - name: ðŸ“‹ Obtener Ãºltima URL del APK
        id: get_apk_url
        run: |
          echo "ðŸ“¦ Obteniendo informaciÃ³n del Ãºltimo build..."

          BUILD_INFO=$(eas build:list --limit 1 --platform android --json --non-interactive)

          echo "ðŸ” Build Info:"
          echo "$BUILD_INFO"  # Ver el contenido completo de la respuesta para depuraciÃ³n

          if [ -z "$BUILD_INFO" ] || [ "$(echo "$BUILD_INFO" | jq length)" -eq 0 ]; then
            echo "âŒ No se encontrÃ³ ningÃºn build."
            exit 1
          fi

          APK_URL=$(echo "$BUILD_INFO" | jq -r '.[0].artifacts.buildUrl')

          if [ -z "$APK_URL" ]; then
            echo "âŒ No se encontrÃ³ la URL del APK."
            exit 1
          fi

          echo "ðŸ“¦ APK URL: $APK_URL"
          echo "apk_url=$APK_URL" >> $GITHUB_OUTPUT
        env:
          EAS_EMAIL: ${{ vars.EAS_EMAIL }}
          EAS_PASSWORD: ${{ vars.EAS_PASSWORD }}

      - name: ðŸ“¤ Enviar URL a Discord
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d "{\"content\": \"âœ… APK disponible: ${{ steps.get_apk_url.outputs.apk_url }}\"}" \
            $DISCORD_WEBHOOK_URL
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
