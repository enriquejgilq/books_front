name: Obtener Ãºltimo APK de EAS y notificar a Discord

on:
  workflow_dispatch:

jobs:
  get-latest-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v3

      - name: Instalar eas-cli
        run: npm install -g eas-cli

      - name: Autenticarse con EAS
        run: eas whoami
        env:
          EAS_ACCESS_TOKEN: ${{ secrets.EAS_ACCESS_TOKEN }}

      - name: Obtener Ãºltima URL del APK
        id: get_apk_url
        run: |
          echo "ðŸ“¦ Obteniendo informaciÃ³n del Ãºltimo build..."

          BUILD_INFO=$(eas build:list --limit 1 --platform android --json --non-interactive)
          echo "ðŸ” Build Info: $BUILD_INFO"

          if [ -z "$BUILD_INFO" ]; then
            echo "âŒ No se obtuvo informaciÃ³n del build."
            exit 1
          fi

          BUILD_COUNT=$(echo "$BUILD_INFO" | jq length)
          if [ "$BUILD_COUNT" -eq 0 ]; then
            echo "âŒ No se encontrÃ³ ningÃºn build."
            exit 1
          fi

          APK_URL=$(echo "$BUILD_INFO" | jq -r '.[0].artifacts.buildUrl')

          if [ -z "$APK_URL" ]; then
            echo "âŒ No se encontrÃ³ la URL del APK."
            exit 1
          fi

          echo "ðŸ“¦ APK URL: $APK_URL"
          echo "apk_url=$APK_URL" >> $GITHUB_OUTPUT
        env:
          EAS_ACCESS_TOKEN: ${{ secrets.EAS_ACCESS_TOKEN }}

      - name: Enviar mensaje a Discord
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d "{\"content\": \"ðŸš€ Se generÃ³ un nuevo APK: ${{ steps.get_apk_url.outputs.apk_url }}\"}" \
          ${{ secrets.DISCORD_WEBHOOK_URL }}
