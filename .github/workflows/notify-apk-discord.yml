name: Obtener √∫ltimo APK de EAS y notificar a Discord

on:
  push:
    branches:
      - test-2  # Cambiar a la rama adecuada, por ejemplo, main

jobs:
  get-latest-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v3

      - name: Instalar dependencias
        run: |
          sudo apt-get update
          sudo apt-get install -y expect
          npm install -g eas-cli

      - name: Autenticarse con eas login
        run: |
          expect <<EOF
          spawn eas login
          expect "Email address:"
          send "${{ vars.EAS_USERNAME }}\r"
          expect "Password:"
          send "${{ vars.EAS_PASSWORD }}\r"
          expect eof
          EOF
        env:
          EAS_EMAIL: ${{ vars.EAS_EMAIL }}
          EAS_PASSWORD: ${{ vars.EAS_PASSWORD }}

      - name: Obtener √∫ltimo build y enviar a Discord
        run: |
          echo "üì¶ Obteniendo informaci√≥n del √∫ltimo build..."

          # Ejecutar el comando y guardar salida y error
          eas build:list --limit 1 --platform android --json --non-interactive > build_output.json 2> build_error.log

          # Mostrar salida est√°ndar
          echo "üîç Salida est√°ndar del build:"
          cat build_output.json || echo "‚ö†Ô∏è No se pudo leer build_output.json"

          # Mostrar errores capturados
          echo "üîç Salida de error (si la hay):"
          cat build_error.log || echo "‚ö†Ô∏è No se pudo leer build_error.log"

          # Verificar si el archivo tiene contenido
          if [ ! -s build_output.json ]; then
            echo "‚ùå Error: No se obtuvo informaci√≥n del build. Posible error:"
            cat build_error.log
            exit 1
          fi

          # Extraer la URL del APK usando jq
          APK_URL=$(cat build_output.json | jq -r '.[0].artifacts.buildUrl')

          if [ -z "$APK_URL" ]; then
            echo "‚ùå No se encontr√≥ la URL del APK."
            exit 1
          fi

          echo "üì¶ APK URL: $APK_URL"

          curl -X POST -H "Content-Type: application/json" \
          -d "{\"content\": \"üöÄ Nuevo APK generado: $APK_URL\"}" \
          ${{ secrets.DISCORD_WEBHOOK_URL }}
